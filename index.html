<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GeoTracker</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    
    <style>
        /* Custom styles to ensure full height and no scrolling on body */
        body, html {
            height: 100%;
            margin: 0;
            overflow: hidden;
            font-family: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        }
        
        /* Custom Leaflet Marker Pulse */
        .user-marker {
            background-color: #3b82f6;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            border: 3px solid white;
            box-shadow: 0 0 10px rgba(0,0,0,0.3);
            display: block;
        }

        /* Map z-index handling */
        .leaflet-pane { z-index: 0 !important; }
        .leaflet-top, .leaflet-bottom { z-index: 10 !important; }
    </style>
</head>
<body class="bg-gray-100 flex flex-col h-full relative">

    <!-- Top Bar -->
    <div class="bg-white shadow-md z-20 p-4 flex justify-between items-center flex-shrink-0">
        <div class="flex items-center gap-2">
            <div id="status-icon-container" class="p-2 rounded-full bg-gray-100 text-gray-600 transition-colors duration-300">
                <!-- Navigation Icon -->
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="status-icon"><polygon points="3 11 22 2 13 21 11 13 3 11"></polygon></svg>
            </div>
            <div>
                <h1 class="font-bold text-lg text-gray-800 leading-tight">GeoTracker</h1>
                <p id="status-text" class="text-xs text-gray-500">Ready to track</p>
            </div>
        </div>
        
        <!-- Error Message (Hidden by default) -->
        <div id="error-msg" class="hidden text-red-500 text-xs bg-red-50 px-2 py-1 rounded"></div>
    </div>

    <!-- Map Container -->
    <div class="flex-grow relative z-0">
        <div id="map" class="absolute inset-0 bg-gray-200"></div>
        
        <!-- Current Location Overlay -->
        <div id="coords-overlay" class="hidden absolute top-4 right-4 z-[400] bg-white/90 backdrop-blur px-3 py-1.5 rounded-full text-xs font-mono shadow border border-gray-200 text-gray-600 pointer-events-none">
            0.00000, 0.00000
        </div>
    </div>

    <!-- Stats Panel -->
    <div class="bg-white/90 backdrop-blur-sm border-t border-gray-200 p-6 z-20 pb-8 flex-shrink-0 transition-all duration-300">
        <!-- Stats Grid -->
        <div class="grid grid-cols-2 gap-4 mb-6">
            <!-- Distance -->
            <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex flex-col items-center justify-center">
                <div class="flex items-center gap-2 text-gray-400 text-xs uppercase tracking-wider mb-1">
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21.3 15.3a2.4 2.4 0 0 1 0 3.4l-2.6 2.6a2.4 2.4 0 0 1-3.4 0L2.7 8.7a2.41 2.41 0 0 1 0-3.4l2.6-2.6a2.41 2.41 0 0 1 3.4 0l12.6 12.6z"></path><line x1="13" y1="7" x2="14" y2="8"></line><line x1="9" y1="11" x2="10" y2="12"></line><line x1="5" y1="15" x2="6" y2="16"></line><line x1="19" y1="19" x2="21" y2="21"></line></svg>
                    Distance
                </div>
                <div id="distance-display" class="text-2xl font-black text-gray-800">0 m</div>
            </div>
            
            <!-- Speed -->
            <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex flex-col items-center justify-center">
                <div class="flex items-center gap-2 text-gray-400 text-xs uppercase tracking-wider mb-1">
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline></svg>
                    Speed
                </div>
                <div class="text-2xl font-black text-gray-800">
                    <span id="speed-display">0.0</span> <span class="text-sm font-normal text-gray-500">km/h</span>
                </div>
            </div>
        </div>

        <!-- Controls -->
        <div class="flex gap-3">
            <button id="toggle-btn" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-3 px-6 rounded-xl font-bold flex items-center justify-center gap-2 transition-all active:scale-95 shadow-lg shadow-blue-200">
                <svg id="play-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="block"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>
                <svg id="pause-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="hidden"><rect x="6" y="4" width="4" height="16"></rect><rect x="14" y="4" width="4" height="16"></rect></svg>
                <span id="btn-text">Start Tracking</span>
            </button>

            <button id="reset-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-700 p-3 rounded-xl flex items-center justify-center transition-all active:scale-95" title="Reset Path">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M23 4v6h-6"></path><path d="M1 20v-6h6"></path><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path></svg>
            </button>
        </div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <script>
        // --- State Variables ---
        let isTracking = false;
        let distance = 0; // meters
        let speed = 0; // km/h
        let path = []; // Array of [lat, lng]
        let watchId = null;
        let map, marker, polyline;

        // --- DOM Elements ---
        const toggleBtn = document.getElementById('toggle-btn');
        const resetBtn = document.getElementById('reset-btn');
        const btnText = document.getElementById('btn-text');
        const playIcon = document.getElementById('play-icon');
        const pauseIcon = document.getElementById('pause-icon');
        const distanceDisplay = document.getElementById('distance-display');
        const speedDisplay = document.getElementById('speed-display');
        const statusIconContainer = document.getElementById('status-icon-container');
        const statusIcon = statusIconContainer.querySelector('.status-icon');
        const statusText = document.getElementById('status-text');
        const errorMsg = document.getElementById('error-msg');
        const coordsOverlay = document.getElementById('coords-overlay');

        // --- Helper Functions ---
        
        // Haversine Formula
        function getDistanceFromLatLonInMeters(lat1, lon1, lat2, lon2) {
            const R = 6371e3; 
            const dLat = ((lat2 - lat1) * Math.PI) / 180;
            const dLon = ((lon2 - lon1) * Math.PI) / 180;
            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                      Math.cos((lat1 * Math.PI) / 180) * Math.cos((lat2 * Math.PI) / 180) *
                      Math.sin(dLon / 2) * Math.sin(dLon / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c;
        }

        function formatDistance(meters) {
            if (meters > 1000) return `${(meters / 1000).toFixed(2)} km`;
            return `${Math.round(meters)} m`;
        }

        // --- Map Initialization ---
        function initMap() {
            // Initialize map view
            map = L.map('map').setView([0, 0], 2);

            // Add OSM Tiles
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; OpenStreetMap contributors'
            }).addTo(map);

            // Custom User Icon
            const userIcon = L.divIcon({
                className: 'custom-div-icon',
                html: `<div class="user-marker"></div>`,
                iconSize: [20, 20],
                iconAnchor: [10, 10]
            });

            // Initialize Layers
            marker = L.marker([0, 0], { icon: userIcon }).addTo(map);
            polyline = L.polyline([], { color: '#ef4444', weight: 4 }).addTo(map);

            // Initial Geolocation to center map
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (pos) => {
                        const { latitude, longitude } = pos.coords;
                        const latLng = [latitude, longitude];
                        map.setView(latLng, 16);
                        marker.setLatLng(latLng);
                        updateCoordsOverlay(latitude, longitude);
                    },
                    (err) => {
                        console.warn("Initial location failed:", err.message);
                        showError("Location access needed to center map.");
                    },
                    { enableHighAccuracy: true }
                );
            }
        }

        // --- App Logic ---

        function updateUI() {
            // Update Buttons
            if (isTracking) {
                toggleBtn.className = "flex-1 bg-amber-500 hover:bg-amber-600 text-white py-3 px-6 rounded-xl font-bold flex items-center justify-center gap-2 transition-all active:scale-95 shadow-lg shadow-amber-200";
                playIcon.classList.add('hidden');
                pauseIcon.classList.remove('hidden');
                btnText.textContent = "Pause";
                
                statusIconContainer.className = "p-2 rounded-full bg-green-100 text-green-600 transition-colors duration-300";
                statusIcon.classList.add('animate-pulse');
                statusText.textContent = "Tracking active...";
            } else {
                toggleBtn.className = "flex-1 bg-blue-600 hover:bg-blue-700 text-white py-3 px-6 rounded-xl font-bold flex items-center justify-center gap-2 transition-all active:scale-95 shadow-lg shadow-blue-200";
                playIcon.classList.remove('hidden');
                pauseIcon.classList.add('hidden');
                btnText.textContent = "Start Tracking";
                
                statusIconContainer.className = "p-2 rounded-full bg-gray-100 text-gray-600 transition-colors duration-300";
                statusIcon.classList.remove('animate-pulse');
                statusText.textContent = "Ready to track";
            }

            // Update Stats
            distanceDisplay.textContent = formatDistance(distance);
            speedDisplay.textContent = speed.toFixed(1);
        }

        function updateCoordsOverlay(lat, lng) {
            coordsOverlay.classList.remove('hidden');
            coordsOverlay.textContent = `${lat.toFixed(5)}, ${lng.toFixed(5)}`;
        }

        function showError(msg) {
            errorMsg.textContent = msg;
            errorMsg.classList.remove('hidden');
            setTimeout(() => {
                errorMsg.classList.add('hidden');
            }, 5000);
        }

        function startTracking() {
            if (!navigator.geolocation) {
                showError("Geolocation is not supported by your browser.");
                return;
            }

            isTracking = true;
            updateUI();

            const options = {
                enableHighAccuracy: true,
                timeout: 10000,
                maximumAge: 0
            };

            watchId = navigator.geolocation.watchPosition(
                (position) => {
                    const { latitude, longitude, speed: geoSpeed } = position.coords;
                    const newLatLng = [latitude, longitude];

                    // Speed calculation
                    const currentSpeedKmH = (geoSpeed || 0) * 3.6;
                    speed = currentSpeedKmH < 1 ? 0 : currentSpeedKmH;

                    // Distance Calculation
                    if (path.length > 0) {
                        const lastPoint = path[path.length - 1];
                        const dist = getDistanceFromLatLonInMeters(lastPoint[0], lastPoint[1], latitude, longitude);
                        
                        // Noise filter (3 meters)
                        if (dist > 3) {
                            distance += dist;
                            path.push(newLatLng);
                            polyline.addLatLng(newLatLng);
                        }
                    } else {
                        // First point
                        path.push(newLatLng);
                        polyline.addLatLng(newLatLng);
                    }

                    // Map Updates
                    marker.setLatLng(newLatLng);
                    map.panTo(newLatLng, { animate: true });
                    updateCoordsOverlay(latitude, longitude);
                    
                    // UI Updates
                    updateUI();
                    errorMsg.classList.add('hidden');
                },
                (err) => {
                    showError(`Error: ${err.message}`);
                    stopTracking();
                },
                options
            );
        }

        function stopTracking() {
            isTracking = false;
            if (watchId !== null) {
                navigator.geolocation.clearWatch(watchId);
                watchId = null;
            }
            updateUI();
        }

        function resetApp() {
            stopTracking();
            distance = 0;
            speed = 0;
            path = [];
            polyline.setLatLngs([]);
            updateUI();
        }

        // --- Event Listeners ---
        
        toggleBtn.addEventListener('click', () => {
            if (isTracking) {
                stopTracking();
            } else {
                startTracking();
            }
        });

        resetBtn.addEventListener('click', resetApp);

        // --- Boot ---
        window.addEventListener('DOMContentLoaded', initMap);

    </script>
</body>
</html>
